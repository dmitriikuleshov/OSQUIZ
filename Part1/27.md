https://habr.com/ru/companies/ruvds/articles/578788/

### Планирование процессов: Обзор и Введение

Планирование процессов — это фундаментальная часть операционной системы (ОС), которая отвечает за распределение ресурсов процессора между различными задачами (процессами и потоками). Эффективное планирование позволяет повысить производительность системы, уменьшить время отклика и обеспечить сбалансированную работу всех процессов.

#### 1. Основные понятия:

-   **Процесс** — это программа в состоянии выполнения. Каждый процесс имеет:
    -   **Код программы** (текстовый сегмент)
    -   **Данные программы** (сегмент данных)
    -   **Стеки** для обработки функций и прерываний
-   **Поток (thread)** — наименьшая единица выполнения внутри процесса.
-   **Контекст процесса** — состояние процесса, включая регистры, указатель на стек, счетчик команд и т.д.
-   **Контекстное переключение** — процесс сохранения состояния текущего процесса и загрузка состояния другого.

#### 2. Цели планирования процессов:

-   **Производительность** — максимизация использования ресурсов.
-   **Время отклика** — минимизация задержек для интерактивных процессов.
-   **Пропускная способность** — выполнение как можно большего числа процессов за единицу времени.
-   **Справедливость** — равномерное распределение ресурсов между процессами.
-   **Балансировка нагрузки** — равномерное распределение нагрузки между процессорами в многопроцессорных системах.

### Планирование процессов в Linux:

Linux использует сложный многослойный механизм планирования, который эволюционировал с течением времени. Современные версии ядра Linux (начиная с 2.6) применяют планировщик CFS (Completely Fair Scheduler).

#### 1. Основные концепции планировщика Linux:

-   **Completely Fair Scheduler (CFS)** — планировщик, основанный на принципе справедливого распределения процессорного времени между всеми процессами.
-   **Время виртуального выполнения (vruntime)** — метрика, которая показывает, сколько процесс провел на процессоре. Процессы с меньшим vruntime получают приоритет.
-   **Красно-черное дерево** — структура данных, используемая для организации процессов в порядке их vruntime.
-   **Классы планировщиков**:
    -   **SCHED_NORMAL** — для обычных процессов (взаимодействие с пользователем).
    -   **SCHED_BATCH** — для процессов с низким приоритетом и без строгих требований к времени отклика.
    -   **SCHED_IDLE** — для процессов, выполняемых в фоновом режиме.
    -   **SCHED_FIFO и SCHED_RR** — для реального времени (FIFO и Round Robin).

#### 2. Алгоритмы планирования в Linux:

-   **SCHED_NORMAL (CFS):**

    -   Основной алгоритм для пользовательских процессов.
    -   Время выполнения процесса рассчитывается на основе vruntime.
    -   Процесс, имеющий наименьший vruntime, получает процессор.
    -   Используется красно-черное дерево для эффективного поиска процесса с минимальным vruntime.

-   **SCHED_FIFO (первый пришел, первый обслужен):**
    -   Подходит для задач реального времени.
    -   Процесс выполняется до тех пор, пока не будет заблокирован или добровольно не уступит процессор.
-   **SCHED_RR (круговой алгоритм):**

    -   Модификация FIFO, где процессам отводится определенный квант времени.
    -   Если процесс не завершился за квант времени, он перемещается в конец очереди.

-   **SCHED_BATCH:**

    -   Используется для пакетных заданий.
    -   Не требует быстрого отклика, процессы получают время процессора, когда он свободен.

-   **SCHED_IDLE:**
    -   Для фоновых задач, которые выполняются, когда процессор простаивает.

#### 3. Контекстное переключение:

Контекстное переключение в Linux — это операция, при которой система сохраняет состояние текущего процесса и загружает состояние следующего процесса. Это дорогостоящая операция, поэтому планировщик старается минимизировать частоту переключений.

### Примеры планирования процессов:

**Пример 1:**

-   Два процесса с одинаковым приоритетом запускаются одновременно.
-   Планировщик CFS распределяет процессорное время поровну между ними.
-   Если один из процессов выполняет системный вызов и блокируется, второй процесс получает больше процессорного времени.

**Пример 2:**

-   Процесс реального времени с SCHED_FIFO запускается наряду с обычными процессами.
-   Процесс реального времени получит приоритет над всеми остальными до тех пор, пока не будет завершен.

### Преимущества планировщика Linux:

-   **Гибкость** — поддержка множества классов планирования.
-   **Масштабируемость** — эффективная работа на многопроцессорных системах.
-   **Эффективность** — низкая стоимость операций благодаря красно-черному дереву.

### Заключение:

Планирование процессов — критически важный аспект любой ОС. Современные ОС, такие как Linux, используют сложные, но эффективные алгоритмы планирования, обеспечивающие высокую производительность и стабильность работы системы. Понимание механизмов планирования помогает в оптимизации производительности приложений и корректном распределении ресурсов.
