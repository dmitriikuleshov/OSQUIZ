### Планирование процессов: введение

**Планирование процессов** — это механизм, посредством которого операционная система (ОС) распределяет ресурсы, включая процессорное время, между различными процессами. В многопроцессорных системах планирование становится более сложным, так как ресурсы распределяются между несколькими процессорами, работающими параллельно.

#### Основные задачи планирования в многопроцессорных системах:

1. **Сбалансированная загрузка процессоров**: равномерное распределение задач между процессорами.
2. **Минимизация времени выполнения задач**: обеспечение эффективного использования процессоров.
3. **Справедливость**: предоставление равных возможностей всем процессам.
4. **Максимизация производительности**: использование всех процессоров с минимальными задержками.

Многопроцессорные системы могут быть:

-   **Симметричными** (SMP, Symmetric Multiprocessing): все процессоры равноправны и могут выполнять любые задачи.
-   **Асимметричными** (AMP, Asymmetric Multiprocessing): некоторые процессоры выделены для выполнения специальных задач.

---

### Принципы планирования в многопроцессорных системах

В многопроцессорных системах ключевыми аспектами планирования являются:

1. **Разделение времени**: задачи распределяются между процессорами таким образом, чтобы они выполнялись параллельно.
2. **Совместное использование пространства**: задачи распределяются по памяти и другим ресурсам, чтобы избежать конфликтов и обеспечить их эффективное использование.

#### Разделение времени

**Разделение времени** в контексте многопроцессорных систем означает, что процессоры обрабатывают задачи одновременно, обеспечивая равномерное использование времени выполнения. Это достигается с помощью следующих методов:

1. **Распределённое планирование**:

    - Каждый процессор имеет свой локальный планировщик, который управляет задачами, привязанными к этому процессору.
    - Преимущества:
        - Уменьшение накладных расходов на синхронизацию между процессорами.
        - Локальные данные кэша процессора используются более эффективно.
    - Недостатки:
        - Возможен дисбаланс загрузки процессоров.

2. **Централизованное планирование**:

    - Один глобальный планировщик распределяет задачи между процессорами.
    - Преимущества:
        - Лучшая балансировка нагрузки.
    - Недостатки:
        - Узкое место из-за необходимости синхронизации.

3. **Миграция процессов**:

    - Если один процессор перегружен, задачи могут быть перенесены на менее загруженные процессоры.
    - Используется для балансировки нагрузки.

4. **Групповое планирование**:
    - Связанные процессы (например, потоки одного приложения) группируются вместе и обрабатываются одним процессором для повышения эффективности.

#### Совместное использование пространства

**Совместное использование пространства** связано с распределением ресурсов, таких как память, кэш процессора и каналы ввода-вывода, между процессами. Это важно для обеспечения согласованности данных и предотвращения конфликтов доступа.

1. **Распределение памяти**:

    - Каждый процесс или поток получает свою область памяти.
    - Процессоры могут делить доступ к общей памяти, что требует использования механизмов синхронизации (например, семафоров или мьютексов).

2. **Использование кэша**:

    - Для повышения производительности процессоры используют локальный кэш.
    - Проблемы:
        - **Инвалидизация кэша**: когда один процессор обновляет данные, которые также кэшируются другим процессором, необходимо синхронизировать их содержимое.

3. **Совместный доступ к устройствам ввода-вывода**:
    - Процессоры могут одновременно обращаться к устройствам ввода-вывода.
    - Для предотвращения конфликтов используется очередность доступа.

---

### Основные подходы к планированию в многопроцессорных системах

#### 1. **Глобальная очередь**

-   Все процессы размещаются в одной общей очереди.
-   Процессоры извлекают задачи из этой очереди для выполнения.

**Преимущества**:

-   Простота реализации.
-   Хорошая балансировка нагрузки между процессорами.

**Недостатки**:

-   Высокие накладные расходы на синхронизацию между процессорами.
-   Возможны конфликты при доступе к очереди.

---

#### 2. **Локальные очереди**

-   Каждому процессору назначается своя очередь задач.
-   Процессоры выполняют задачи только из своих очередей.

**Преимущества**:

-   Улучшение производительности за счёт уменьшения конфликтов при доступе к очередям.
-   Более эффективное использование локального кэша.

**Недостатки**:

-   Возможен дисбаланс нагрузки, если один процессор перегружен задачами.

---

#### 3. **Смешанная стратегия**

-   Используется комбинация локальных и глобальной очередей:
    -   В нормальных условиях процессоры выполняют задачи из локальных очередей.
    -   Если один процессор перегружен, задачи мигрируют из локальной очереди на менее загруженные процессоры.

**Преимущества**:

-   Сбалансированное распределение нагрузки.
-   Эффективное использование ресурсов.

---

### Примеры алгоритмов планирования

#### 1. **First-Come, First-Served (FCFS)**

-   Простейший алгоритм, где процессы обрабатываются в порядке их поступления.
-   Характерен для асимметричных систем с одной главной очередью.

---

#### 2. **Round-Robin (RR)**

-   Процессы выполняются в течение фиксированного кванта времени, после чего переключаются.
-   Применим как в глобальной, так и в локальной модели.

---

#### 3. **Task Stealing (Кража задач)**

-   Если процессор завершает выполнение всех задач в своей очереди, он "крадёт" задачи из очередей других процессоров.
-   Позволяет эффективно балансировать нагрузку в системе.

---

#### 4. **Weighted Fair Queuing (WFQ)**

-   Каждому процессу или группе процессов назначается вес, определяющий долю процессорного времени.
-   Применяется для обеспечения справедливости.

---

### Реализация планирования в современных ОС

#### 1. **Linux**

-   Использует Completely Fair Scheduler (CFS), который поддерживает многопроцессорность.
-   Задачи могут мигрировать между процессорами для балансировки нагрузки.

#### 2. **Windows**

-   Применяет систему глобальных очередей с динамическим перераспределением задач.

#### 3. **macOS**

-   Использует стратегию многопоточного планирования с балансировкой нагрузки между процессорами.

---

### Пример

Предположим, в системе с четырьмя процессорами есть три задачи:

-   **P1**: время выполнения 10 мс.
-   **P2**: время выполнения 15 мс.
-   **P3**: время выполнения 20 мс.

#### Сценарий с глобальной очередью:

-   Все задачи размещаются в одной очереди.
-   Каждый процессор извлекает задачи по мере их завершения.
-   Задачи распределяются следующим образом:
    -   CPU1: P1.
    -   CPU2: P2.
    -   CPU3: P3.

#### Сценарий с локальными очередями:

-   Каждому процессору выделяется своя очередь.
-   Если P3 назначена CPU3, её выполнение займёт больше времени, чем у CPU1 и CPU2.

---

### Заключение

Планирование процессов в многопроцессорных системах включает в себя как временное распределение задач между процессорами, так и совместное использование ресурсов. Оно требует баланса между простотой реализации и эффективностью выполнения. Современные ОС используют смешанные подходы для оптимизации загрузки процессоров и обеспечения справедливости. Выбор подхода зависит от архитектуры системы и требований приложений.
